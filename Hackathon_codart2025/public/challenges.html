<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CODART 3.0 Challenges</title>
  <link rel="stylesheet" href="styles2.css" />
  <!-- Add font imports for better typography -->
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet" />
  <style>
    .status-image {
      position: absolute;
      top: 15px;
      right: 15px;
      display: none;
      width: 28px;
      height: 28px;
      transition: transform 0.3s ease;
    }

    .status-image.visible {
      transform: scale(1.1);
    }

    /* Ensure challenge numbers are properly positioned */
    .challenge {
      position: relative;
      padding-right: 80px;
      /* Make space for the number badge */
    }

    /* Additional styles for grid layout */
    .challenges-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 25px;
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }

    /* Make sure container is properly structured */
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>CTF Challenges</h1>

    <div class="navigation-buttons">
      <button onclick="redirectToScorecard()" class="nav-button scorecard-btn">
        Scoreboard
      </button>
      <button onclick="logout()" class="nav-button logout-btn">Logout</button>
    </div>
    <div class="challenges-container" id="challengesGrid">
      <!-- Challenges will be dynamically generated here -->
    </div>
  </div>

  <div class="total-points">
    Total Points: <span id="total-points">0</span>
  </div>

<script>
    // TEAM NAME MANDATORY + BACK BUTTON BLOCK - ADD THIS FIRST
    let teamNameSet = false;

    function ensureTeamName() {
      if (!teamNameSet || !sessionStorage.getItem('teamName')) {
        let teamName = sessionStorage.getItem('teamName') || '';
        while (!teamName || teamName.trim() === '') {
          teamName = prompt('Team name is MANDATORY before proceeding:');
          if (teamName === null) {
            window.location.href = 'index.html';
            return false;
          }
          teamName = teamName.trim();
        }
        sessionStorage.setItem('teamName', teamName);
        fetch('/register-team', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ teamName: teamName })
        }).catch(() => { }); // Silent fail
        teamNameSet = true;
        return true;
      }
      return true;
    }

    // Block back button completely
    window.history.pushState(null, null, location.href);
    window.onpopstate = function () {
      if (!ensureTeamName()) return;
      window.history.pushState(null, null, location.href);
    };

    // Force team name on page load/back
    window.addEventListener('pageshow', function (event) {
      if (event.persisted || !sessionStorage.getItem('teamName')) {
        ensureTeamName();
      }
    });

    // --- Data Definitions (Unchanged) ---
    const points = new Array(15).fill(30);
    const fileNames = [

      //0

      "challenge 1.zip",

      //1

      "link.txt",

      //2

      "challenge 3.zip",

      //3

      "challenge 4.zip",

      //4

      "challenge 5.zip",

      //5

      "aaaa.txt",

      //6

      "code.txt",

      //7

      "OIP.jpg",

      //8

      "boom.txt",

      //9

      "1111.zip",

      //10

      "eee.zip",

      //11

      "ch.txt",

      //12

      "test.py",

      //13

      "redirect.txt",

      //14

      "yourfile.txt"

    ];



    const descriptions = [
        //0
        "Hey hacker, ready for your first sneak peek into the world of secrets?\n\nYou landed on a webpage crafted by a rookie coder who wasn’t too careful… Something valuable is hidden here, but only those who know how to look beyond the surface will find it.\nRemember, flags look like this: flag{...} — but that’s all we’ll say for now.",
        //1
        "HIDDEN PIXELS\nThere’s more to this adorable Pikachu you will find in the files.\nSpirit of the true hacker: secrets hide where nobody expects.\nCan you uncover the message concealed deep within the pixels?",
        //2
        "!!!! At first glance, the pattern seems ordinary. But every shadow hides another, and only by unraveling each twist will you reveal what’s been concealed so cleverly !!!!",
        //3
        "Buried deep within this folder lies a secret waiting to be unlocked.\nFirst, look closely at the rhythmic pulses hidden in the code—they form a key to open what’s sealed tight.\nOnce the lock is undone, a ciphered message awaits, concealed in ciphertext only the cleverest can decode.\nCan you unravel the layers and claim the flag?",
        //4
        "Yo, we hacked this sketchy website that spits out binary for whatever you type. But peep this — only one secret phrase makes it spit out a binary that actually says something real. Find the vibe, drop the right phrase, and decode that binary for the flag.",
        "SOMETIMES THINGS ARE NOT AS COMPLICATED AS THEY SEEM TO BE. LOOK CLOSELY HACKER YOU CAN SURELY CRACK THIS<br> FLAG FORMAT - flag{codart25}",
        //6
        "I came across this malicious code, but I'm not quite sure what language it's written in... can you help me?",
        //7
        "You've been provided the top secret data, only accessible to the pro hackers. The flag is not clearly visible as it has been hidden, use your techniques to retrive the secrets it beholds!",
        //8
        "You've successfully intercepted a curious digital artifact. The flag is not immediately visible, but it has been carefully obscured in two distinct stages. Your mission requires you to first unearth the hidden data from its unexpected location within the file's structure. Once extracted, the resulting text will be meaningless—you must then apply the correct key-based shift to restore the document to its original, readable form and claim the final flag.",
        //9
        "DECODE - COMBINE - SUBMIT - NEXT CHALLENGE !!!!!",
        //10
        "A stream of zeros and ones guards the first gate. Beyond lies a locked vision—pierce its veil to find the final whisper. Follow where bits lead, images conceal.",
        //11
        "HEY CODER! Here is a peice of text from a clever man's archive. I suggest you should repeat the same operation a couple of times to reach you goal.",
        //12
        "A strange Python script was recovered from an old authentication system. <br> It no longer contains any plaintext credentials, but it still validates a secret flag using a transformation function.<br>Your job is to reverse the logic hidden inside the script and recover the only input string that passes the check.",
        //13
        "They say every profile on the internet leaves traces—some loud, some quiet, and some hiding in plain sight.<br>A certain Instagram page has been whispering clues for a while now, but only those who observe carefully ever notice anything unusual.",
        //14
        " A small script is guarding a secret. It doesn't seems to be really complicated but accepts only certain inputs to revel the secrets.<br> MAKE SURE YOUR FLAG MAKES SOME SENSE!!!<br> FLAG FORMAT - flag{some sensible word}"
    ];


    const tags = [

      //0

      ["web exploitation", "base64", "javascript"],

      //1

      ["steganography", "hidden message", "image"],

      //2

      ["qr code", "encoded", "easy"],

      //3

      ["zip file", "morse code"],

      //4

      ["binary exploitation", "webapp", "encryption"],

      //5

      ["encryption", "easy"],

      //6

      ["encrypted", "alphanumeric", "sequential"],

      //7

      ["stegnography", "extraction"],

      //8

      ["hex", "multi-layered"],

      //9

      ["medium", "ciphering"],

      //10

      ["binary", "password guessing"],

      //11

      ["shift", "decoding", "medium"],

      //12

      ["reverse engineering", "python", "SHA-256"],

      //13

      ["OSINT", "Social Media", "investigation"],

      //14

      ["permutation", "ordering", "logic"]

    ];



    // --- Session Storage Initialization ---
    let totalPoints = parseInt(sessionStorage.getItem("totalPoints")) || 0;
    const completedChallenges = new Set(
      JSON.parse(sessionStorage.getItem("completedChallenges")) || []
    );
    const revealedHints = new Set(
      JSON.parse(sessionStorage.getItem("revealedHints")) || []
    );
    const teamName = sessionStorage.getItem("teamName") || prompt("Enter your team name:");
    sessionStorage.setItem("teamName", teamName);

    document.getElementById("total-points").textContent = totalPoints;

    const challengesGrid = document.getElementById("challengesGrid");
    const tickImageSrc = "tick.png";

    // --- Challenge Grid Generation (Unchanged, includes loading stored flag input) ---
    for (let i = 0; i < 15; i++) {
        const challengeDiv = document.createElement("div");
        challengeDiv.className = "challenge";
        challengeDiv.id = `challenge${i + 1}`;
        challengeDiv.setAttribute("data-challenge-number", i + 1);

        const tagsHTML = tags[i]
          .map((tag) => `<span class="tag">${tag}</span>`)
          .join(" ");

        challengeDiv.innerHTML = `
          <h2>Challenge ${i + 1}</h2>
          <p class="challenge-points">${points[i]} Points</p>
          <p class="challenge-description">${descriptions[i]}</p>
          <div class="tags-container">${tagsHTML}</div>
          <input type="text" placeholder="flag{your_flag}" class="flag-input" value="${sessionStorage.getItem(`flagInput${i}`) || ""}">
          <div class="buttons-row">
              <a href="files/${fileNames[i]}" download="${fileNames[i]}" class="download-button">Download File</a>
              <button onclick="checkFlag(${i}, event)" class="submit-button">Submit Flag</button>
          </div>
          <button onclick="showHint(${i})" class="hint-button">Hint</button>
          <p class="hint" id="hint${i}"></p>
          <p class="error-message"></p>
          <img src="${tickImageSrc}" alt="Completed" class="status-image" id="status${i}">
        `;

        challengesGrid.appendChild(challengeDiv);
    }
    // --- End Challenge Grid Generation ---


    // --- Check Flag Function (Ensures input is saved permanently on correct flag) ---
    function checkFlag(challengeIndex, event) {
        event.preventDefault();

        const challenge = document.getElementsByClassName("challenge")[challengeIndex];
        const input = challenge.getElementsByClassName("flag-input")[0];
        const errorMessage = challenge.getElementsByClassName("error-message")[0];
        const button = challenge.getElementsByClassName("submit-button")[0];
        const statusImage = challenge.querySelector(".status-image");

        // Save input value before attempting submission (for persistence on reload)
        sessionStorage.setItem(`flagInput${challengeIndex}`, input.value); 

        fetch("/submit-flag", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                teamName: teamName,
                challengeIndex: challengeIndex,
                flag: input.value.trim(),
            }),
        })
          .then((res) => res.json())
          .then((data) => {
            errorMessage.textContent = data.message;

            if (data.message === "Correct flag!") {
                totalPoints = data.score;
                document.getElementById("total-points").textContent = totalPoints;

                if (!completedChallenges.has(challengeIndex)) {
                    completedChallenges.add(challengeIndex);
                    // Update session storage for completed challenges
                    sessionStorage.setItem(
                      "completedChallenges",
                      JSON.stringify(Array.from(completedChallenges))
                    );
                }

                // Set the input value to permanent and disable
                input.disabled = true;
                button.disabled = true;
                statusImage.style.display = "block";
                statusImage.classList.add("visible");
                errorMessage.style.color = "#00b09b";
            } else {
                errorMessage.style.color = "#ff6b6b";
            }
        })
        .catch(() => {
            errorMessage.textContent = "Server error. Try again later.";
            errorMessage.style.color = "#ff6b6b";
        });
    }
    // --- End Check Flag Function ---


    // --- Show Hint Function (Ensures hint state is saved permanently) ---
    function showHint(challengeIndex) {
        if (
            confirm(
              "2 points shall be deducted on revealing the hint. Do you want to proceed?"
            )
        ) {
            fetch(`/hints/${challengeIndex}`)
              .then((res) => res.json())
              .then((data) => {
                const hint = document.getElementById(`hint${challengeIndex}`);
                hint.textContent = data.hint;
                hint.style.display = "block";
                const hintButton = document.getElementsByClassName("hint-button")[challengeIndex];
                hintButton.disabled = true;

                if (!revealedHints.has(challengeIndex)) {
                    totalPoints -= 2;
                    revealedHints.add(challengeIndex);
                    // Update session storage for revealed hints
                    sessionStorage.setItem(
                      "revealedHints",
                      JSON.stringify([...revealedHints])
                    );
                }
                
                // ⭐ FIX: Save the actual hint text to session storage
                sessionStorage.setItem(`hintText${challengeIndex}`, data.hint);
                
                document.getElementById("total-points").textContent = totalPoints;
                sessionStorage.setItem("totalPoints", totalPoints);

                fetch("/scorecard/update", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ teamName: teamName, points: -2 }),
                })
                  .then((response) => {
                    if (!response.ok) throw new Error("Failed to update score");
                    return response.text();
                  })
                  .then(() => console.log("Score updated due to hint usage"))
                  .catch((error) => console.error("Error:", error));
            });
        }
    }


    // --- Initialize Page Function (Crucial for loading persistent state) ---
function initializePage() {
        // 1. Restore Revealed Hints state
        revealedHints.forEach((index) => {
            const hint = document.getElementById(`hint${index}`);
            const hintButton = document.getElementsByClassName("hint-button")[index];
            
            if (hint) {
              // ⭐ FIX: Retrieve and display the saved hint text
              const savedHintText = sessionStorage.getItem(`hintText${index}`);
              if (savedHintText) {
                hint.textContent = savedHintText;
                hint.style.display = "block";
              }
            }

            if (hintButton) {
              hintButton.disabled = true;
            }
        });

        // 2. Restore Completed Challenges state (Disabling input/button, showing tick)
        completedChallenges.forEach((index) => {
            const input = document.getElementsByClassName("flag-input")[index];
            const button = document.getElementsByClassName("submit-button")[index];
            const statusImage = document.getElementById(`status${index}`);
            
            if (input) {
              input.disabled = true;
            }
            if (button) {
              button.disabled = true;
            }
            if (statusImage) {
              statusImage.style.display = "block";
              statusImage.classList.add("visible");
            }
        });
    }
    // Call initializePage() to apply persistent state on page load
    initializePage(); 
    // --- End Initialize Page Function ---


    // --- Resize and Navigation Functions (Unchanged) ---
    function handleResize() {
        const challengesGrid = document.getElementById("challengesGrid");
        if (window.innerWidth <= 1024) {
            challengesGrid.style.gridTemplateColumns = "1fr";
        } else {
            challengesGrid.style.gridTemplateColumns = "repeat(2, 1fr)";
        }
    }

    handleResize();
    window.addEventListener("resize", handleResize);

    function redirectToScorecard() {
        window.location.href = "scorecard.html";
    }

    function logout() {
        sessionStorage.clear();
        window.location.href = "main.html";
    }

</script>

</body>

</html>
